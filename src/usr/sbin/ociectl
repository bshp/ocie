#!/bin/bash
    
# Custom config
if [[ ! -z "${OCIE_CONFIG}" ]];then
    if [[ -d "${OCIE_CONFIG}" ]];then
        if [[ -f "${OCIE_CONFIG}/config.ocie" ]];then
            . ${OCIE_CONFIG}/config.ocie;
        else
            echo "Ocie: Application config [ config.ocie ] not found in path [ ${OCIE_CONFIG} ]";
        fi;
    else
        echo "Ocie: Unable to load config, [ ${OCIE_CONFIG} ] is not a directory or not readable";
    fi;
else
    # Default config
    if [[ -f "${OCIE_LIB}/types/${APP_TYPE}.ocie" ]];then
        . ${OCIE_LIB}/types/${APP_TYPE}.ocie;
    else
        echo "Ocie: Application config not found in any available path, type: [ config.ocie ]";
        echo "Ocie: Create an 'config.ocie' in your application, set the environment OCIE_CONFIG, e.g OCIE_CONFIG=/etc/myapp/path_to_definition";
        exit 1;
    fi;
fi;
    
function show_help()
{
    echo "OCIE Application Control";
    echo
    echo "Syntax: ociectl [ --reload | --run | --stop ]";
    echo
    echo "Parameters:";
    echo
    echo "--reload   Reload the application";
    echo
    echo "--run      Run the application";
    echo
    echo "--stop     Stop the application";
    echo
    echo "--test     Test the applications config";
    echo
}
    
function ocie_shutdown()
{
    echo
    echo "Ocie: Recieved stop signal, shutting down";
    app_shutdown;
    exit 0;
}
    
function ocie_certs()
{
    if [[ $(type -t app_certs) == function ]];then
        app_certs;
    fi;
}
    
function ocie_config()
{
    if [[ $(type -t app_config) == function ]];then
        app_config;
    fi;
}
    
function ocie_update()
{
    if [[ $(type -t app_update) == function ]];then
        app_update;
    fi;
}
    
function ocie_test()
{
    if [[ $(type -t app_test) == function ]];then
        echo $(app_test);
    fi;
}
    
function ocie_reload()
{
    app_reload;
}
    
function ocie_start()
{
    ocie_certs;
    ocie_config;
    ocie_update;
    app_start;
}
    
# Shutdown - SIGINT, SIGTERM, SIGWINCH
trap ocie_shutdown 2 15 28
    
for cmds in "$@";do
    shift;
    case "$cmds" in
        '--help')
            show_help;;
        '--reload')
            ocie_reload;;
        '--run')
            ocie_start;;
        '--stop')
            ocie_shutdown;;
        '--test')
            ocie_test;;
        *);;
    esac;
done;
